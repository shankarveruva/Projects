<!--HTML segment-->
<html>
    <head>
        <!--Styling: CSS segment-->
        <style> 
            /* For headings */
            h1,h2{
                color: darkslategrey;
                font-family: monospace;
            }
            
            /* For div (id=instruction) */
            #instructions{
                color: darkslateblue;
                border: 1px solid black;
                font-family: serif;
            }
            
            /* For tooltip */
            div.toolTip {	
			    text-align: center;			
			    width: 150px;					
			    height: 55px;					
			    font: 12px Arial;		
			    background: floralwhite ;	
			    border-radius: 8px;			
			}
            
            /* For p tag */
            #note{
                font: 15px Arial;
                font-style: italic;
            }

        </style>
    </head>
    
<!--Body segment-->
    <body>
        
        <!--Title-->
        <title>FIT5147 Assignment 1 : Part 3</title>
        
        <!--Heading 1-->
        <h1 style="text-align: center;">Programming Exercise 3: D3</h1>
        
        <!--Div segment for Instructions and Brief-->
        <div id='instructions'>
            
            <!--Heading 2-->
            <h2>Instructions & Brief:</h2>
            
            <!--Instructions-->
            <ol>
                <li>Read in the data using D3.</li>
                <li>Draw the locations as circles, and make the radius of circles proportional to the total trading amount at that location.</li>
                <li>Draw the trading as lines between the locations, and make the thickness of lines proportional to the amount.</li>
                <li>Provide these following interactions:</li>
                <ul>
                    <li>Hovering on a circle, highlight the circle and all lines connected to it (by making other circles and lines transparent).</li>
                    <li>Hovering on a circle, show a tooltip with its information about the total amount of trading  at that location and the number of connected locations.</li>
                </ul>
                <li>Circles should be rendered on top of lines.</li>
            </ol>
            
            <p id='note'>PS: Open this file with the 'Brackets' app and select 'Live Preview' to view the content of this file.</p>
            
        </div>
                
        <!--Div segment for SVG canvas-->
        <div id='canvas' style="text-align:center;"></div>
                    
        <!--Script segment-->
        <script src="https://d3js.org/d3.v4.min.js"></script>
        
        <script>
            
            // Upon the window load
            window.onload = function(){
                
                // Initialising variables
                var width = 1000;
                var height = 600;
                var totalAmount = [];
                var connectedLocations=[];
                
                // Initialising svg canvas
                var svgCanvas = d3.select("#canvas")
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("class", "svgCanvas");
                
                // Initialising tooltip
                var toolTip = d3.select("#canvas")
                    .append("div")
                    .attr('class','toolTip')
                    .style("position", "absolute")
                    .style("z-index", "10")
                    .style("visibility", "hidden");                
                
                // Reading the input data
                d3.json("data.json", function(givenData){
                    
                    // Displaying the input data onto the console
                    console.log(givenData);                
                
                    // Calculating total amount and number of connected locations for each node
                    givenData.nodes.forEach(function(node, index){
                        totalAmount.push(0);
                        connectedLocations.push(0);
                        givenData.links.forEach(function(link){
                            if (link.node01 == node.id || link.node02 == node.id){
                                connectedLocations[index] += 1;
                                totalAmount[index] += link.amount;
                            }
                        })
                    })
                                                            
                    // Creating lines for each link
                    svgCanvas.selectAll("line").data(givenData.links)
                        .enter().append("line")
                    
                        // Setting x1,x2,y1 and y2 for line/link
				        .attr("x1",function(link){
                            nodes = givenData.nodes;
                            nodes.forEach(function(node){
                                if (link.node01 == node.id)
                                    x1 = node.x
                            }); return x1;
                        })
                        .attr("y1",function(link){
                            nodes = givenData.nodes;
                            nodes.forEach(function(node){
                                if (link.node01 == node.id)
                                    y1 = node.y; 
                                }); return y1;
                        })
                        .attr("x2",function(link){
                            nodes = givenData.nodes;
                            nodes.forEach(function(node){
                                if (link.node02 == node.id)
                                    x2 = node.x; 
                            }); return x2;
                        })
                        .attr("y2",function(link){
                            nodes = givenData.nodes;
                            nodes.forEach(function(node){
                                if (link.node02 == node.id)
                                    y2 = node.y; 
                            }); return y2;
                        })
                    
                        // Setting stroke and stroke width
                        .attr("stroke-width",function(link){
                            return link.amount*0.012;
                        })
				        .attr("stroke","black")
                    
                    
                // Creating circles for each node/location 
				svgCanvas.selectAll("circle").data(givenData.nodes)
                    .enter().append("circle")
                    
                    // Setting circle origin and radius
                    .attr('cx', function(node){
                        return node.x;
                    })
                    .attr('cy', function(node){
                        return node.y;
                    })
                    .attr('r', function(node, index){
                        return totalAmount[index]/45;
                    })
                    
                    // Setting the color for the circles/nodes
                    .attr("fill", "red")
					
                    // When the user hovers on a circle/node
                    .on("mouseover", function(node, index){	
                    
                        // Setting visibility of all circles and lines to 0.04
				        svgCanvas.selectAll("circle, line").attr("opacity", 0.04);
						
                        // Setting visibility of the selected circle to 1
						d3.select(this).attr("opacity", 1);	

                        // Displaying the node name, total amount and number of connected nodes
                        toolTip.html('Location: ' + node.id + '<br>Total Amount: ' + totalAmount[index] + '<br>Connected Nodes: ' + connectedLocations[index])
                            .style('visibility', 'visible')
                            .style("top", (event.pageY-30)+"px")
                            .style("left",(event.pageX+20)+"px");

                        // Highlighting the lines that are connected to selected circle
						svgCanvas.selectAll("line")
                    
                            // Setting the line opacity
                            .attr("opacity", function(link){          
                                if (link.node01 == node.id ||  link.node02 == node.id)
                                    return 1;
                                else
                                    return 0.04;
                            })
		            })	
					
                    // When the user hovers away from circle/node
			        .on("mouseout", function(node){	
                    
                        // Setting visibility of all the circles and lines to 1
						d3.selectAll("circle, line").attr("opacity", 1);
                        
                        // Hiding the tooltip text
                        toolTip.style("visibility", "hidden");
			        });       
            });                
        }
        </script>
    </body>
</html>